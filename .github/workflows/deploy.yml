name: Deploy

on:
  push:
    branches:
      - main

concurrency:
  group: deploy-main
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          debug: true
          script_stop: true
          command_timeout: 20m
          script: |
            set -euo pipefail
            set -x
            LOG=/tmp/deploy.log
            exec > >(tee -a "$LOG") 2>&1
            trap 'rc=$?; echo "FAILED rc=$rc"; tail -n 200 "$LOG"; exit $rc' ERR
            cd "/home/ubuntu/lignin/lignin-frontend"
            git fetch --all --prune
            git reset --hard origin/main
            export CI=1
            export PNPM_APPROVE_BUILD=1
            which pnpm
            pnpm -v
            export STRAPI_INTERNAL_URL=http://lignin-prod:1337
            export STRAPI_SSG_URL=http://127.0.0.1:1337
            export STRAPI_URL=http://lignin-prod:1337
            export NEXT_PUBLIC_STRAPI_URL=http://lignin-prod:1337
            curl -fsS "http://127.0.0.1:1337/_health" >/dev/null || curl -fsS "http://127.0.0.1:1337/admin" >/dev/null
            pnpm install --frozen-lockfile --include=optional
            pnpm build
            docker compose --profile prod up --build -d
